<!doctype html>
<html lang="en">
<head>
    <title>ds8086 | 2025.09.12</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/assets/css/blog.css">
</head>

<body>

<div class="sidebar">
    <a href="/index.html">home</a>
    <a href="/blog/blog.html">blog</a>
    <a href="https://github.com/ds8086/" target="_blank">code</a>
    <a href="/about.html">about</a>
</div>

<div class="pagenav">
    <a href="#underground">underground</a>
    <a href="#materials" style="font-size: 12pt;">- materials</a>
    <a href="#setup">setup</a>
    <a href="#ssh-key" style="font-size: 12pt;">- ssh key</a>
    <a href="#linux-server" style="font-size: 12pt;">- linux server</a>
    <a href="#firewall" style="font-size: 12pt;">- firewall</a>
    <a href="#testing">testing</a>
    <a href="#final-thoughts">final thoughts</a>
    <a href="#server-hardening" style="font-size: 12pt;">- server hardening</a>
    <a href="#serverless" style="font-size: 12pt;">- serverless</a>
</div>

<div class="content">
<section>
    <h1>2025.09.12</h1>
    <h2 id="underground">underground</h2>
    <p>
        SSH; synonymous with <a href="https://www.inadequacy.org/public/stories/2001.12.2.42056.2147.html" target="_blank">Lunix</a> management but also a viable,
        lightweight substitute for that bloated VPN client you've been married to since OPNSense forked in 2015. No admin rights? No problem! If you can get tcp/22 out
        to the internet, you have all that you need.
    </p>
    <h3 id="materials">materials</h3>
    <p>
        For this effort you'll need the following materials.
    </p>
    <ul>
        <li>A minimal Linux server (SSH and little else).</li>
        <li>A Windows client (accessible via RDP).</li>
        <li>A router/firewall.</li>
        <li><a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html" target="_blank">PuTTY</a> (SSH and keygen).</li>
    </ul>
    <p>
        Below is my demo environment where the entirety of the internet exists as <b>10.0.0.0/8</b> (use your imagination).
    </p>
    <table>
        <tr>
            <th>Node</th>
            <th>IP Address</th>
        </tr>
        <tr>
            <td>Router (WAN)</td>
            <td>10.0.0.1/8</td>
        </tr>
        <tr>
            <td>Router (LAN)</td>
            <td>192.168.1.1/24</td>
        </tr>
        <tr>
            <td>Linux server</td>
            <td>192.168.1.10/24</td>
        </tr>
        <tr>
            <td>Windows client</td>
            <td>192.168.1.11/24</td>
        </tr>
        <tr>
            <td>Corporate egress</td>
            <td>10.69.4.20/8</td>
        </tr>
    </table>
    <p>
        For the router, I am using a virtual machine running <a href="https://mikrotik.com/download" target="_blank">MikroTik</a> CHR (cloud hosted router) which is
        free to use without a license, but you are limited to 1Mbps throughput. Great for lab environments and more than enough for this post. The default
        firewall configuration below should suffice for what a <u>physical</u> MikroTik device would ship with, and it will serve as the starting point.
    </p>
    <pre>
        <code>
/ip firewall filter
add action=accept chain=input comment="defconf: accept established,related,untracked" connection-state=established,related,untracked
add action=drop chain=input comment="defconf: drop invalid" connection-state=invalid
add action=accept chain=input comment="defconf: accept ICMP" in-interface-list=lan protocol=icmp
add action=accept chain=input comment="defconf: accept to local loopback (for CAPsMAN)" dst-address=127.0.0.1
add action=accept chain=forward comment="defconf: accept established,related, untracked" connection-state=established,related,untracked
add action=drop chain=input comment="defconf: drop all not coming from LAN" in-interface-list=!lan
add action=drop chain=forward comment="defconf: drop invalid" connection-state=invalid
add action=drop chain=forward comment="defconf: drop all from WAN not DSTNATed" in-interface-list=wan
        </code>
    </pre>
</section>

<section>
    <h2 id="setup">setup</h2>
    <h3 id="ssh-key">ssh key</h3>
    <p>
        Fire up <b>puttygen.exe</b> and create a new key pair. You should <i>consider</i> using a modern key like EdDSA and you should <u>definitely</u> secure your private
        key with a password. Once generated, save the private key and copy the public key string to notepad or something similar.
    </p>
    <a href="/assets/images/20250912/01.png"><img src="/assets/images/20250912/01.png"></a>
    <h3 id="linux-server">linux server</h3>
    <p>
        SSH into your Linux server and run the code block below either using <b>sudo</b> or the root account. Swap the string within the double-quotes for the public key
        you copied.
    </p>
    <pre>
        <code>
adduser -U -m tunnel
mkdir /home/tunnel/.ssh
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGdzKzXHB8YlNf2SghkpuDVQkpnFe7WXjQ7Y3EqJ93Vr tunnel" > /home/tunnel/.ssh/authorized_keys
        </code>
    </pre>
    <p>
        Since your Linux server will eventually be exposed to the internet, you should <i>really</i> disable password authentication for SSH. Do so only if you are using
        key-based authentication for your root/admin account already... or if you are good with using console login for your Linux server. Open the SSH config
        <b>/etc/ssh/sshd_config</b> in your favorite Linux text editor, and find the <b>PasswordAuthentication</b> line. Ensure it is set to <b>no</b> and <u>not</u>
        commented out. Save the file if needed, bounce the SSH daemon if there were any changes.
    </p>
    <a href="/assets/images/20250912/02.png"><img src="/assets/images/20250912/02.png"></a>
    <pre>
        <code>
systemctl restart sshd
        </code>
    </pre>
    <h3 id="firewall">firewall</h3>
    <p>
        For your firewall configuration you <i>should</i> know the source of traffic which will be forwarded. For example, the egress IP address of your corporate network.
        You should <u>not</u> create a port forward and firewall rule which forwards all traffic from the internet... With that in mind, remember that the "internet" in my
        example is <b>10.0.0.0/8</b>, the WAN IP address of my MikroTik is <b>10.0.0.1</b> and my corporate egress IP address is <b>10.69.4.20</b>. The NAT and firewall
        filter rules below will allow SSH traffic from only my corporate egress IP address which will be forwarded to the Linux server.
    </p>
    <pre>
        <code>
/ip firewall nat
add action=dst-nat chain=dstnat dst-port=22 in-interface-list=wan protocol=tcp src-address=10.69.4.20 to-addresses=192.168.1.10 to-ports=22

/ip firewall filter
add action=accept chain=forward comment="allow: ssh from office" dst-port=22 in-interface-list=wan protocol=tcp src-address=10.69.4.20 place-before=5
        </code>
    </pre>
    <p>
        Printing the firewall config shows the newly created firewall rule placed <i>above</i> the three drop rules at the bottom of the default firewall rule list.
    </p>
    <a href="/assets/images/20250912/03.png"><img src="/assets/images/20250912/03.png"></a>
    <h3 id="putty">putty</h3>
    <p>
       Configuring putty is the last setup step with <b>tunnel@10.0.0.1</b> used for the username and IP address.
    </p>
    <a href="/assets/images/20250912/04.png"><img src="/assets/images/20250912/04.png"></a>
    <p>
        In the <b>Connection > SSH > Auth > Credentials</b> section, the path to the previously saved private key is specified.
    </p>
    <a href="/assets/images/20250912/05.png"><img src="/assets/images/20250912/05.png"></a>
    <p>
        In the <b>Connection > SSH > Tunnels</b> section, a random port above 1024 is selected for the source port with the destination set to <b>192.168.1.11:3389</b>
        which is the local IP address of the Windows client and the port for RDP. Both the <b>Local</b> and <b>Auto</b> radio buttons are selected.
    </p>
    <a href="/assets/images/20250912/06.png"><img src="/assets/images/20250912/06.png"></a>
</section>

<section>
    <h2 id="testing">testing</h2>
    <p>
        With putty configured the connection can be opened and the tunnel established.
    </p>
    <a href="/assets/images/20250912/07.png"><img src="/assets/images/20250912/07.png"></a>
    <p>
        A quick <b>Get-NetTCPConnection</b> confirms that the local machine is listening for connections on the selected port.
    </p>
    <a href="/assets/images/20250912/08.png"><img src="/assets/images/20250912/08.png"></a>
    <p>
        Launch <b>mstsc</b> specifying the destination as <b>127.0.0.1:42069</b> then enter the password for the Windows client user.
    </p>
    <a href="/assets/images/20250912/09.png"><img src="/assets/images/20250912/09.png"></a>
    <a href="/assets/images/20250912/10.png"><img src="/assets/images/20250912/10.png"></a>
    <p>
        As if by magic, RDP traffic is tunneled over the SSH connection to the remote Windows client. Note the lack of default gateway on the Windows client which proves
        that the RDP connection is undeniably taking place over the SSH tunnel rather than by routing.
    </p>
    <a href="/assets/images/20250912/11.png"><img src="/assets/images/20250912/11.png"></a>
</section>

<section>
    <h2 id="final-thoughts">final thoughts</h2>
    <h3 id="server-hardening">server hardening</h3>
    <p>
        With RDP functional via the SSH tunnel, a good "hardening" measure would be to limit where the <b>tunnel</b> user is <i>allowed</i> to tunnel connections which
        is easily accomplished via a "per-user" configuration added to <b>/etc/ssh/sshd_config</b>.
    </p>
    <pre>
        <code>
# Tunnel user
Match User tunnel
        PermitOpen 192.168.1.11:3389
        </code>
    </pre>
    <p>
        To show that the configuration above limits tunneled connections, I updated the <b>putty</b> config to tunnel traffic to <b>192.168.1.12:3389</b> then attempted
        to RDP to <b>127.0.0.1:42069</b>. The RDP connection fails, but what do the SSH logs from the server say?
    </p>
    <pre>
        <code>
journalctl -t sshd
        </code>
    </pre>
    <a href="/assets/images/20250912/12.png"><img src="/assets/images/20250912/12.png"></a>
    <p>
        Very good. The <b>tunnel</b> user can SSH into the server, but cannot tunnel traffic to a destination other than <b>192.168.1.11:3389</b>. In addition to
        restricting where traffic can be tunneled, the user can be assigned to the <b>nologin</b> shell via the code below.
    </p>
    <pre>
        <code>
usermod -s /sbin/nologin tunnel
        </code>
    </pre>
    <p>
        Now, should the <b>tunnel</b> user attempt to log into the server via the console <i>or</i> SSH, the login will fail. With this in place the PuTTY config must
        be updated to use the <i>Don't start a shell or command at all</i> protocol option in the <b>Connection > SSH</b> section as shown below.
    </p>
    <a href="/assets/images/20250912/13.png"><img src="/assets/images/20250912/13.png"></a>
    <h3 id="serverless">serverless</h3>
    <p>
        <i>"Wait! You could do all of this without a Linux server right?!"</i>
    </p>
    <p>
        Could you? Yes. <i>Should</i> you? Hey, it's your network... Live your best life! Here is what that setup would look like assuming your are still limiting access
        to <i>only</i> your corporate egress IP address <b>10.69.4.20</b> in this example. Instead of the NAT and filter rule previously provided, the filter and SSH
        forwarding config below would be used. Note that the filter rule is using the <b>input</b> chain rather than <b>forward</b>.
    </p>
    <pre>
        <code>
/ip firewall filter
add action=accept chain=input comment="allow: ssh from office" dst-port=22 in-interface-list=wan protocol=tcp src-address=10.69.4.20 place-before=5

/ip ssh
set forwarding-enabled=local
        </code>
    </pre>
    <p>
        Just as with the Linux server, you <u>really</u> want to create a limited user account for the tunnel, MikroTik ships with a <b>read</b> group which would
        suffice. Again, like the Linux server, if you are willing to expose your router via SSH, even if access is limited to a single public IP address, you should only
        allow key authentication and disable password authentication on the router entirely. The <a href="https://help.mikrotik.com/docs/" target="_blank">MikroTik Docs</a>
        provide all the finer details for user creation and SSH key import if that is really the route you want to go. I am not personally a fan of this method, if I did not
        have access to a Linux server, I would go Raspberry Pi before opening external SSH to my router.
    </p>
    <p>
        Regardless of the method selected, beware of people who might care about SSH leaving your corporate network. Your tunnel may collapse.
    </p>    
</section>

<section>
    <h4>2025.09.15 edit</h4>
    <p>
        Added <b>nologin</b> shell to hardening config after conversation with JS.
    </p>
</section>

<div class="footer">
    <a href="/blog/20250829.html">2025.08.29-â–º</a>
</div>

</div>
</body>
</html>