<!doctype html>
<html lang="en">
<head>
    <title>ds8086 | 2025.10.20</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="linux, kvm, vnc">
    <link rel="stylesheet" href="/assets/css/blog.css">
</head>

<body>

<div class="sidebar">
    <a href="/index.html">home</a>
    <a href="/blog/blog.html">blog</a>
    <a href="https://github.com/ds8086/" target="_blank">code</a>
    <a href="/about.html">about</a>
</div>

<div class="pagenav">
    <a href="#console">console</a>
    <a href="#error" style="font-size: 12pt;">- error</a>
    <a href="#firewall" style="font-size: 12pt;">- firewall</a>
    <a href="#vncdisplay" style="font-size: 12pt;">- vncdisplay</a>
    <a href="#confirmation" style="font-size: 12pt;">- confirmation</a>
</div>

<div class="content">
<section>
    <h1>2025.10.20</h1>
    <h2 id="console">console</h2>
    <p>
        Since recently migrating my home lab from ESXi to KVM, I have been using the VNC console built into Cockpit for initial configuration of domains. It works... but
        only just. You will frequently find yourself fighting with resolution changes for domains running a GUI or text which runs beyond the display limits for those
        without. ESXi has VMWare Remote Console, KVM <i>should</i> have something similar, right? Enter <b>Virt Viewer</b> available for download from
        <a href="https://virt-manager.org/download.html">virt-manager.org</a>.
    </p>
    <a href="/assets/images/20251020/01.png"><img src="/assets/images/20251020/01.png"></a>
    <h3 id="error">error</h3>
    <p>
        After installing <b>Virt Viewer</b> on my local Windows 11 box, I tried the Remote Viewer option. No dice...
    </p>
    <a href="/assets/images/20251020/02.png"><img src="/assets/images/20251020/02.png"></a>
    <a href="/assets/images/20251020/03.png"><img src="/assets/images/20251020/03.png"></a>
    <h3 id="firewall">firewall</h3>
    <p>
        When VNC is enabled for a domain, the KVM host starts with <b>5900/tcp</b> for connections to the first domain, and increments ports by one for each additional
        domain thereafter. Armed with this information, I ran the code below adding <b>5900-5909/tcp</b> to the ports allowed through the firewall.
    </p>
    <pre>
        <code>
firewall-cmd --zone=public --add-ports=5900-5909/tcp --permanent
firewall-cmd --reload
        </code>
    </pre>
    <p>
        A quick sanity check shows the KVM host <i>is</i> making a connection on <b>5902/tcp</b>, but despite the additional firewall rule, Remote Viewer remains
        nonfunctional.
    </p>
    <a href="/assets/images/20251020/04.png"><img src="/assets/images/20251020/04.png"></a>
    <h3 id="vncdisplay">vncdisplay</h3>
    <p>
        Running the <b>vncdisplay</b> subcommand in <b>virsh</b> shows that VNC connections are expected on <b>127.0.0.1:2</b>... This is misleading. The KVM host
        is <u>NOT</u> expecting a connection on <b>2/tcp</b> for VNC, instead it is using port 5900 + 2 (<b>5902/tcp</b>).
    </p>
    <a href="/assets/images/20251020/05.png"><img src="/assets/images/20251020/05.png"></a>
    <p>
        The issue here is actually the <b>127.0.0.1</b> address. I found a blog post online saying this needs to be <b>0.0.0.0</b>. No <i>actual</i> explanation
        was provided, just... update this address and it works. So what does that process look like? Start by powering down the domain, then edit the domain config
        using <b>virsh edit $domain</b>. Find the <b>graphics type</b> element and change the two <b>127.0.0.1</b> entries to <b>0.0.0.0</b>, then save the file.
    </p>
    <a href="/assets/images/20251020/06.png"><img src="/assets/images/20251020/06.png"></a>
    <p>
        Next up, open <b>/etc/libvirt/qemu.conf</b> in vi(m), then uncomment the <b>vnc_listen</b> line. Save the file and bounce the <b>libvirtd</b> daemon.
    </p>
    <a href="/assets/images/20251020/10.png"><img src="/assets/images/20251020/10.png"></a>
    <h3 id="confirmation">confirmation</h3>
    <p>
        Start up the domain and re-run the <b>vncdisplay</b> command. Output will display <b>:num</b>.
    </p>
    <a href="/assets/images/20251020/07.png"><img src="/assets/images/20251020/07.png"></a>
    <p>
        Back in cockpit, the <i>Manual connection</i> information now displays <b>0.0.0.0</b> rather than <b>127.0.0.1</b>...
    </p>
    <a href="/assets/images/20251020/08.png"><img src="/assets/images/20251020/08.png"></a>
    <p>
        ...and launching the remote viewer is now successful.
    </p>
    <a href="/assets/images/20251020/09.png"><img src="/assets/images/20251020/09.png"></a>
    <p>
        Suppose I could uninstall VMWare Remote Console now, eh?
    </p>
</section>

<div class="footer">
    <a href="/blog/20251017.html">2025.10.17-â–º</a>
</div>

</div>
</body>
</html>