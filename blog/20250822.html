<!doctype html>
<html lang="en">
<head>
    <title>ds8086 | 2025.08.22</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/assets/css/blog.css">
</head>

<body>

<div class="sidebar">
    <a href="/index.html">home</a>
    <a href="/blog/blog.html">blog</a>
    <a href="https://github.com/ds8086/" target="_blank">code</a>
    <a href="/about.html">about</a>
</div>

<div class="pagenav">
    <a href="#tina-ii">tina II</a>
    <a href="#dc01">dc01</a>
    <a href="#ntp" style="font-size: 12pt;">- ntp</a>
    <a href="#group-policy" style="font-size: 12pt;">- group policy</a>
    <a href="#dc02">dc02</a>
    <a href="#pre-reqs" style="font-size: 12pt;">- prerequisites</a>
    <a href="#domain-join" style="font-size: 12pt;">- domain join</a>
    <a href="#replication">replication</a>
    <a href="#rsync-dc01" style="font-size: 12pt;">- rsync (dc01)</a>
    <a href="#rsync-dc02" style="font-size: 12pt;">- rsync (dc02)</a>
    <a href="#rsync-cron" style="font-size: 12pt;">- rsync (cron)</a>
    <a href="#next-steps">next steps</a>
</div>

<div class="content">
<section>
    <h1>2025.08.22</h1>
    <h2 id="tina-ii">tina II</h2>
    <p>
        In my <a href="/blog/20250811.html" target="_blank">last post</a> I provisioned a Debian powered Active Directory forest. Why? Because why not? A quick recap
        of the AD environment; the entire forest/domain (<b>ad.lab.local</b>) is currently supported by a single domain controller (<b>dc01</b>). I had put together
        a short hit list of <i>next steps</i> for the environment which are reiterated and expanded upon below.
    </p>
    <ul>
        <li>Time synchronization for <b>dc01</b>.</li>
        <li>Group Policy must be enabled.</li>
        <li>A second DC is required.</li>
        <li>AD backup/restore plan.</li>
    </ul>
    <p>
        Let's dive straight into it and see how much of this list I am willing to tackle today.
    </p>
</section>

<section>
    <h2 id="dc01">dc01</h2>
    <p>
        Before provisioning a second domain controller, there are a few things to address on <b>dc01</b>. Shall we?
    </p>
    <h3 id="ntp">ntp</h3>
    <p>
        The first domain controller is currently keeping time by the grace of almighty CMOS. The <a href="https://wiki.samba.org/index.php/Time_Synchronisation">SambaWiki</a>
        covers the topic of time synchronization and you will recall that <b>ntpd</b> was installed during the initial provisioning of the first domain controller,
        <b>dc01</b>. Looking over the documentation reveals an immediate issue; there is a Debian bug concerning the interaction between ntpsec and Samaba. It is
        recommended that <b>chrony</b> be used instead. Right then...
    </p>
    <pre>
        <code>
apt remove ntp -y
        </code>
    </pre>
    <p>
        The documentation references building <b>chrony</b> from source, but the repo package seems to work just fine.
    </p>
    <pre>
        <code>
apt install chrony -y
        </code>
    </pre>
    <p>
        The <b>ntp_signd</b> directory permissions require modification for <b>chrony</b> to function.
    </p>
    <pre>
        <code>
chown root:_chrony /var/lib/samba/ntp_signd/
chmod 750 /var/lib/samba/ntp_signd/
        </code>
    </pre>
    <p>
        A quick check making sure permissions match the documentation confirms that everything is in order.
    </p>
    <a href="/assets/images/20250822/01.png"><img src="/assets/images/20250822/01.png"></a>
    <p>
        The <b>/etc/chrony/chrony.conf</b> file is updated with the info below.
    </p>
    <pre>
        <code>
# Key and drift files
keyfile /etc/chrony/chrony.keys
driftfile /var/lib/chrony/chrony.drift

# Log location
logdir /var/log/chrony

# Stop bad estimates upsetting machine clock
maxupdateskew 100.0

# Tells 'chronyd' to parse the 'adjtime' file to find out if the real-time
# clock keeps local time or UTC. It overrides the 'rtconutc' directive.
hwclockfile /etc/adjtime

# This directive enables kernel synchronisation (every 11 minutes) of the
# real-time clock. Note: cannot be used along with the 'rtcfile' directive.
rtcsync

# Step the system clock instead of slewing it if the adjustment is larger than
# one second, but only in the first three clock updates.
makestep 1 3

# ipaddress of this DC
bindcmdaddress 192.168.1.10

# The source, where we are receiving the time from
server 0.pool.ntp.org     iburst
server 1.pool.ntp.org     iburst
server 2.pool.ntp.org     iburst

# dns netmask
allow 192.168.1.0/24

# Samba NTP
ntpsigndsocket  /var/lib/samba/ntp_signd/
        </code>
    </pre>
    <p>
        The service is restarted following the config file change.
    </p>
    <pre>
        <code>
systemctl restart chrony
        </code>
    </pre>
    <p>
        The service started without issue and checking the Windows 7 domain member, I confirmed that it is successfully syncing time from <b>dc01</b>.
    </p>
    <a href="/assets/images/20250822/02.png"><img src="/assets/images/20250822/02.png"></a>
    <h3 id="group-policy">group policy</h3>
    <p>
        Just as with NTP, Group Policy has its own <a href="https://wiki.samba.org/index.php/Group_Policy" target="_blank">documentation</a> on the SambaWiki.
        I downloaded the latest Administrative Templates from Microsoft and used <b>scp</b> to copy the MSI file over to <b>dc01</b>. For the sake of keeping the code
        below brief-ish, I renamed the MSI file <b>admx.msi</b>.
    </p>
    <pre>
        <code>
apt install msitools
msiextract /root/admx.msi
mv Program\ Files/Microsoft\ Group\ Policy/Windows\ 11\ Sep\ 2024\ Update\ \(24H2\)/PolicyDefinitions/ ./
samba-tool gpo admxload -U Administrator --admx-dir=/root/PolicyDefinitions/
        </code>
    </pre>
    <p>
        There is exactly <u>zero</u> chance I am trying to administer group policies via command line... Heading over to the previously provisioned "management"
        box (<b>srv01</b>) the PowerShell code below installs the Group Policy management console, and makes a quick and dirty SMB share for use with a new GPO.
    </p>
    <pre>
        <code>
Install-WindowsFeature -Name GPMC
New-SmbShare -FullAccess Everyone -Path C:\Share -Name Share
        </code>
    </pre>
    <p>
        A GPO which maps a network drive is quintessential Active Directory. Day one, <i>hour one</i>, this will be a task for your newly provisioned AD environment.
        Remember kids, this is a lab environment. Do not link drive mapping GPOs to the domain root in your production environment.
    </p>
    <a href="/assets/images/20250822/03.png"><img src="/assets/images/20250822/03.png"></a>
    <p>
        Already being logged into a Windows domain member, the all-too-familiar <b>gpupdate /force</b> followed by <b>gpresult</b> shows that the newly minted GPO is
        being applied.
    </p>
    <a href="/assets/images/20250822/04.png"><img src="/assets/images/20250822/04.png"></a>
    <p>
        Which is confirmed by launching explorer.
    </p>
    <a href="/assets/images/20250822/05.png"><img src="/assets/images/20250822/05.png"></a>
</section>

<section>
    <h2 id="dc02">dc02</h2>
    <p>
        With NTP and Group Policy checked off the list, it's time for a second domain controller. Once again, the SambaWiki has
        <a href="https://wiki.samba.org/index.php/Joining_a_Samba_DC_to_an_Existing_Active_Directory" target="_blank">documentation</a> dedicated to the topic. Since I
        <i>now</i> know there are issues with NTP and Samaba DCs, the code for installing packages will include <b>chrony</b> from the start.
    </p>
    <h3 id="pre-reqs">prerequisites</h3>
    <pre>
        <code>
apt-get install acl attr samba winbind libpam-winbind libnss-winbind krb5-config krb5-user dnsutils python3-setproctitle chrony vim -y
        </code>
    </pre>
    <p>
        The <b>/etc/resolv.conf</b> file is updated to use <b>dc01</b> (192.168.1.10) for DNS resolution. 
    </p>
    <pre>
        <code>
echo "nameserver 192.168.1.10" > /etc/resolv.conf
        </code>
    </pre>
    <p>
        The <b>/etc/krb5.conf</b> file is removed and recreated with the content below.
    </p>
    <pre>
        <code>
[libdefaults]
    default_realm = AD.LAB.LOCAL
    dns_lookup_realm = false
    dns_lookup_kdc = true
        </code>
    </pre>
    <p>
        The <b>samba</b> service is bounced then <b>kinit</b> and <b>klist</b> are used to verify domain authentication is functional.
    </p>
    <pre>
        <code>
systemctl restart samba
kinit administrator
klist
        </code>
    </pre>
    <a href="/assets/images/20250822/06.png"><img src="/assets/images/20250822/06.png"></a>
    <p>
        The <b>/etc/chrony/chrony.conf</b> config must be updated to use <b>dc01</b> as a time source via the content below.
    </p>
    <pre>
        <code>
# Key and drift files
keyfile /etc/chrony/chrony.keys
driftfile /var/lib/chrony/chrony.drift

# Log location
logdir /var/log/chrony

# Stop bad estimates upsetting machine clock
maxupdateskew 100.0

# Tells 'chronyd' to parse the 'adjtime' file to find out if the real-time
# clock keeps local time or UTC. It overrides the 'rtconutc' directive.
hwclockfile /etc/adjtime

# This directive enables kernel synchronisation (every 11 minutes) of the
# real-time clock. Note: cannot be used along with the 'rtcfile' directive.
rtcsync

# Step the system clock instead of slewing it if the adjustment is larger than
# one second, but only in the first three clock updates.
makestep 1 3

# ipaddress of this DC
bindcmdaddress 192.168.1.11

# The source, where we are receiving the time from
server dc01.ad.lab.local     iburst

# dns netmask
allow 192.168.1.0/24

# Samba NTP
ntpsigndsocket  /var/lib/samba/ntp_signd/
        </code>
    </pre>
    <h3 id="domain-join">domain join</h3>
    <p>
        After updating the <b>chrony</b> config, the service is bounced. The default <b>samba</b> config is removed, and <b>dc02</b> is joined to the domain as a DC.
    </p>
    <pre>
        <code>
systemctl restart chrony
rm /etc/samba/smb.conf
samba-tool domain join ad.lab.local DC -U "AD\administrator"
        </code>
    </pre>
    <a href="/assets/images/20250822/07.png"><img src="/assets/images/20250822/07.png"></a>
    <p>
        References to <i>replication</i> and lots of green text. That seems good. Can <b>samba</b> be started?
    </p>
    <pre>
        <code>
samba
systemctl status samba
        </code>
    </pre>
    <p>
        ...no. 
    </p>
    <a href="/assets/images/20250822/08.png"><img src="/assets/images/20250822/08.png"></a>
    <p>
        How about after a quick <b>reboot</b>?
    </p>
    <a href="/assets/images/20250822/09.png"><img src="/assets/images/20250822/09.png"></a>
    <p>
        Yes! <b>\o/</b> Looking at the latest log entries does seem to indicate an issue with registering DNS records though.
    </p>
    <a href="/assets/images/20250822/10.png"><img src="/assets/images/20250822/10.png"></a>
    <p>
        The <a href="https://wiki.samba.org/index.php/Joining_a_Samba_DC_to_an_Existing_Active_Directory#Verifying_the_DNS_Entries" target="blank">documentation</a>
        does mention that after starting <b>samba</b>, the DC should be updated to use <i>itself</i> for DNS resolution. Easy fix, the <b>/etc/resolv.conf</b> file
        is updated appropriately, and the DNS registration errors cease. 
    </p>
    <pre>
        <code>
echo "nameserver 192.168.1.11" > /etc/resolv.conf
        </code>
    </pre>
    <p>
        Before moving on, a few lines must be added to the <b>/etc/samba/smb.conf</b> file below the <b>[global]</b> directive...
    </p>
    <pre>
        <code>
dns forwarder = 10.10.0.1
idmap_ldb:use rfc2307 = yes
apply group policies = yes
        </code>
    </pre>
    <p>
        ...and bounce the <b>samba</b> service <i>one</i> more time for luck.
    </p>
    <pre>
        <code>
systemctl restart samba
        </code>
    </pre>
    <p>
        We now have a highly available domain...sort of.
    </p>
</section>

<section>
    <h2 id="replication">replication</h2>
    <p>
        If you expect replication between the two DCs to occur via DFS or even the antiquated <i>FRS</i>, prepare to be disappointed. Before replication is even considered,
        the Built-In User & Group ID Mappings must be backed up from <b>dc01</b> and restored on <b>dc02</b>. This process starts by running the code below on <b>dc01</b>.
    </p>
    <pre>
        <code>
tdbbackup -s .bak /var/lib/samba/private/idmap.ldb
        </code>
    </pre>
    <p>
        The newly created <b>.bak</b> file is copied over to the same directory on <b>dc02</b>, then the code below is ran on <b>dc02</b>.
    </p>
    <pre>
        <code>
rm /var/lib/samba/private/idmap.ldb
mv /var/lib/samba/private/idmap.ldb.bak /var/lib/samba/private/idmap.ldb
net cache flush
        </code>
    </pre>
    <p>
        The <a href="https://wiki.samba.org/index.php/Joining_a_Samba_DC_to_an_Existing_Active_Directory#Built-in_User_&_Group_ID_Mappings" target="_blank">documentation</a>
        cites this process as being required for any domain controllers past the first and while it does not need to occur as frequently as SysVol replication, it should be
        performed periodically. How periodically? Apparently there is a SambaWiki mailing list, get on that if you are interested.
    </p>
    <h3 id="rsync-dc01">rsync (dc01)</h3>
    <p>
        Further <a href="https://wiki.samba.org/index.php/Rsync_based_SysVol_replication_workaround" target="_blank">documentation</a> on the SambaWiki (now my homepage)
        provides instructions for using <b>rsync</b> as a SysVol replication <i>workaround</i> citing it as the simplest option of those few which exist. Simple as it
        may be, it will also introduce caveats into managing Active Directory, specifically that all changes to SysVol <u>must</u> take place on <b>dc01</b>. Not ideal
        but hey, at least Microsoft cannot push a patch to your Debian DC, amiright? Anyway...
    </p>
    <pre>
        <code>
apt install rsync
mkdir /usr/local/samba
mkdir /usr/local/samba/etc
echo "sysvol-replication:Secret1234" > /usr/local/samba/etc/rsyncd-sysvol.secret
        </code>
    </pre>
    <p>
        The <b>/etc/rsyncd.conf</b> config is updated with the block below.
    </p>
    <pre>
        <code>
[SysVol]
path = /var/lib/samba/sysvol/
comment = Samba Sysvol Share
uid = root
gid = root
read only = yes
auth users = sysvol-replication
secrets file = /usr/local/samba/etc/rsyncd-sysvol.secret
strict modes = false
hosts allow = 192.168.1.11
        </code>
    </pre>
    <p>
        The <b>rsync</b> service is started and enabled. Then the status of the service verified.
    </p>
    <pre>
        <code>
systemctl start rsync
systemctl enable rsync
systemctl status rsync
        </code>
    </pre>
    <a href="/assets/images/20250822/11.png"><img src="/assets/images/20250822/11.png"></a>
    <p>
        On to the second DC. <b>\o/</b>
    </p>
    <h3 id="rsync-dc02">rsync (dc02)</h3>
    <p>
        Right to it then!
    </p>
    <pre>
        <code>
apt install rsync
mkdir /usr/local/samba
mkdir /usr/local/samba/etc
echo "Secret1234" > /usr/local/samba/etc/rsync-sysvol.secret
chmod 600 /usr/local/samba/etc/rsync-sysvol.secret
        </code>
    </pre>
    <p>
        Time for an <b>rsync</b> dry run.
    </p>
    <pre>
        <code>
rsync --dry-run -XAavz --delete-after --password-file=/usr/local/samba/etc/rsync-sysvol.secret rsync://sysvol-replication@192.168.1.10/SysVol/ /var/lib/samba/sysvol/
        </code>
    </pre>
    <p>
        No errors from the dry run.
    </p>
    <a href="/assets/images/20250822/12.png"><img src="/assets/images/20250822/12.png"></a>
    <p>
        The recent log entries on <b>dc01</b> provide additional confirmation.
    </p>
    <a href="/assets/images/20250822/13.png"><img src="/assets/images/20250822/13.png"></a>
    <p>
        In the words of Captain Pike; <i>"Punch it!"</i>
    </p>
    <pre>
        <code>
rsync -XAavz --delete-after --password-file=/usr/local/samba/etc/rsync-sysvol.secret rsync://sysvol-replication@192.168.1.10/SysVol/ /var/lib/samba/sysvol/
        </code>
    </pre>
    <p>
        Checking the Group Policy Management console shows that <b>dc02</b> is in sync! <b>\o/</b>
    </p>
    <a href="/assets/images/20250822/14.png"><img src="/assets/images/20250822/14.png"></a>
    <h3 id="rsync-cron">rsync (cron)</h3>
    <p>
       The last step in setting up <b>rsync</b> is to automate the SysVol "replication". No need to over complicate things, <b>cron</b> can handle this.
    </p>
    <pre>
        <code>
crontab -e
        </code>
    </pre>
    <p>
        The content below is used in the new <b>crontab</b> file, and then... we wait.
    </p>
    <pre>
        <code>
# https://wiki.samba.org/index.php/Rsync_based_SysVol_replication_workaround
*/5 * * * *     rsync -XAavz --delete-after --password-file=/usr/local/samba/etc/rsync-sysvol.secret rsync://sysvol-replication@192.168.1.10/SysVol/ /var/lib/samba/sysvol/
        </code>
    </pre>
    <p>
        While waiting, I created an empty GPO for validating SysVol replication. Immediately following GPO creation, <b>dc02</b> is listed as <i>replication in progress</i>.
    </p>
    <a href="/assets/images/20250822/15.png"><img src="/assets/images/20250822/15.png"></a>
    <p>
        A few minutes later, the <b>cron</b> logs on <b>dc02</b> indicate success...
    </p>
    <a href="/assets/images/20250822/16.png"><img src="/assets/images/20250822/16.png"></a>
    <p>
        ...the <b>rsync</b> logs on <b>dc01</b> confirm replication has occured via the <b>cron</b> job...
    </p>
    <a href="/assets/images/20250822/17.png"><img src="/assets/images/20250822/17.png"></a>
    <p>
        ...and <b>dc02</b> is once again listed as <i>replication in sync</i>. <b>\o/</b>
    </p>
    <a href="/assets/images/20250822/18.png"><img src="/assets/images/20250822/18.png"></a>
</section>

<section>
    <h2 id="next-steps">next steps</h2>
    <p>
        I was hoping to check off the entire hit list however, swapping <b>ntp</b> for <b>chrony</b> has made this post longer than I had originally planned. So tune in
        next week (probably) for <i>tina III: AD backup and restore. Same Samba time, same Samba channel!</i>
    </p>
</section>

<div class="footer">
    <a href="/blog/20250829.html">◄-2025.08.29</a><b>...</b><a href="/blog/20250811.html">2025.08.11-►</a>
</div>

</div>
</body>
</html>