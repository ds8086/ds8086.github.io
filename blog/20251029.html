<!doctype html>
<html lang="en">
<head>
    <title>ds8086 | 2025.10.29</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="dnf, linux, reposync">
    <link rel="stylesheet" href="/assets/css/blog.css">
</head>

<body>

<div class="sidebar">
    <a href="/index.html">home</a>
    <a href="/blog/list.html">blog</a>
    <a href="https://github.com/ds8086/" target="_blank">code</a>
    <a href="/about.html">about</a>
</div>

<div class="pagenav">
    <a href="#mirror-2">mirror^2</a>
    <a href="#repotrack" style="font-size: 12pt;">- repotrack</a>
    <a href="#new-repo" style="font-size: 12pt;">- new repo</a>
    <a href="#space" style="font-size: 12pt;">- space</a>
</div>

<div class="content">
<section>
    <h1>2025.10.29</h1>
    <h2>mirror^2</h2>
    <p>
        Today, a quick update on my <a href="/blog/20251024.html" target="_blank">last post</a>; I found a means to selectively include packages in a local repository.
        The solution is not as clean as I would like, but it works. To start, the <b>createrepo</b> package is required in order to manually update repo metadata
        once additional packages are added <i>to</i> the repo.
    </p>
    <pre>
        <code>
dnf install createrepo
        </code>
    </pre>
    <h3 id="repotrack">repotrack</h3>
    <p>
        The <b>repotrack</b> utility, which is included with <b>yum-utils</b>, can be used to download packages and their dependencies. I compiled a short list of
        packages installed on Almalinux machines in my home lab and put the list in a file aptly named <b>packages.txt</b>. The code below is used to download the packages
        and all dependencies into the directory used by the previously implemented <b>reposync</b> process, then update the repo metadata.
    </p>
    <pre>
        <code>
#!/bin/bash

reposync --destdir /var/www/repos/almalinux/9/x86_64/os --repo=baseos --newest-only --exclude=*.i686
repotrack --destdir /var/www/repos/almalinux/9/x86_64/os/baseos/Packages $(cat packages.txt)
createrepo /var/www/repos/almalinux/9/x86_64/os/baseos --update
        </code>
    </pre>
    <p>
        I put the code above into script file named <b>reposync.sh</b> and updated <b>crontab</b> to just execute the script.
    </p>
    <h3 id="new-repo">new repo</h3>
    <p>
        On the servers which will make use of the local mirror, I reverted <b>/etc/yum.repos.d/almalinux-baseos.repo</b> to its original state and created a new repo
        by means of a <i>new</i> config file; <b>/etc/yum.repos.d/almalinux-lan.repo</b> with the contents below.
    </p>
    <pre>
        <code>
[lan]
name=AlmaLinux $releasever - LAN
baseurl=http://mirror.ds.lan/almalinux/$releasever/x86_64/os/baseos
enabled=1
gpgcheck=1
priority=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-AlmaLinux-9
        </code>
    </pre>
    <p>
        As a test, I attempted to install Nginx on a server where it is not present. With the new <b>lan</b> repo configured with the highest priority, it is checked
        first and the package along with its dependencies are listed and available for install.
    </p>
    <a href="/assets/images/20251029/01.png"><img src="/assets/images/20251029/01.png"></a>
    <h3 id="space">space</h3>
    <p>
        So how much space is required for my local mirror now that it contains both the Base OS and my short list of packages from Appstream? Well first how about a look
        at the list of packages I am currently installing from Appstream.
    </p>
    <pre>
        <code>
cockpit
cockpit-machines
cockpit-storaged
createrepo
libguestfs-tools
libvirt
libvirt-client
nginx
qemu-guest-agent
qemu-kvm
vim-enhanced
virt-install
virt-top
yum-utils
        </code>
    </pre>
    <p>
        Less than 2GB, I can live with that.
    </p>
    <a href="/assets/images/20251029/02.png"><img src="/assets/images/20251029/02.png"></a>
    <p>
        Honestly, it could probably be slimmed down even further by cutting the language packs and some of the other Base OS fluff, but I doubt those packages are updated
        often enough to make an impact. They are already there, they can stay.
    </p>
</section>

<div class="footer">
    <a href="/blog/20251024.html">2025.10.24-â–º</a>
</div>

</div>
</body>
</html>